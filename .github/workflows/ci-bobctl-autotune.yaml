name: CI - bobctl autotune

on:
  push:
    branches:
      - main
      - feature/tuning
    paths:
      - 'pkg'
      - 'pkg/**'
      - 'kubescape/**'
      - 'example/mywebapp-chart/**'
      - 'example/webapp-manifest.yaml'
      - 'example/webapp-functional-tests.yaml'
      - 'example/webapp-attacks.yaml'
      - '.github/workflows/**'
      - 'Makefile'
  workflow_dispatch:
  repository_dispatch:
    types: [node-agent-build-complete]


jobs:
  build:
    name: Build bobctl
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo and private submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          token: ${{ secrets.ENTLEIN_PAT}}

      - name: Clone storage dependency
        run: |
          git clone --depth 1 --branch feature/tuning https://github.com/k8sstormcenter/storage.git ../storage

      - name: Verify layout
        run: |
          ls pkg/go.mod pkg/main.go
          ls ../storage/go.mod

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: pkg/go.sum

      - name: Build bobctl
        working-directory: pkg
        run: |
          go build -o ../bin/bobctl ./main.go

      - name: Upload bobctl binary
        uses: actions/upload-artifact@v4
        with:
          name: bobctl
          path: bin/bobctl

  autotune:
    name: Autotune webapp (${{ matrix.os }}, ${{ matrix.k8s-distribution }})
    needs: build
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        k8s-distribution: [k3s]
        kubernetes-version: [v1.33.3]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ENTLEIN_PAT}}

      - name: Patch image tags from dispatch
        if: github.event_name == 'repository_dispatch'
        run: |
          TAG="${{ github.event.client_payload.image_tag }}"
          echo "Patching kubescape/values.yaml with tag: ${TAG}"
          sed -i "s|tag: \"dev-[a-f0-9]*\"|tag: \"${TAG}\"|g" kubescape/values.yaml
          echo "Updated values.yaml:"
          grep 'tag:' kubescape/values.yaml

      - name: Download bobctl binary
        uses: actions/download-artifact@v4
        with:
          name: bobctl
          path: bin

      - name: Make bobctl executable
        run: chmod +x bin/bobctl

      - name: Set up k3s cluster
        if: matrix.k8s-distribution == 'k3s'
        uses: jupyterhub/action-k3s-helm@v4
        with:
          k3s-version: ${{ matrix.kubernetes-version }}+k3s1

      - name: Set up Kind cluster
        if: matrix.k8s-distribution == 'kind'
        uses: helm/kind-action@v1
        with:
          node_image: kindest/node:${{ matrix.kubernetes-version }}

      - name: Verify cluster
        run: |
          kubectl version
          kubectl get nodes
          uname -a
          helm version

      - name: Install kubescape
        run: make kubescape

      - name: Install alertmanager
        run: make alertmanager

      - name: Wait for kubescape components
        run: |
          kubectl wait --for=condition=ready pod -l app=node-agent -n honey --timeout=180s
          kubectl wait --for=condition=ready pod -l app=storage -n honey --timeout=180s
          kubectl wait --for=condition=ready pod -l app=alertmanager -n honey --timeout=120s

      - name: Install and learn webapp
        id: profile
        run: |
          bin/bobctl reinstall \
            --manifest example/webapp-manifest.yaml \
            --functional-tests example/webapp-functional-tests.yaml \
            -n webapp \
            --timeout 10m \
            -v > /tmp/profile-name.txt
          PROFILE=$(cat /tmp/profile-name.txt)
          echo "name=$PROFILE" >> "$GITHUB_OUTPUT"
          echo "Discovered profile: $PROFILE"



      - name: Run autotune
        id: autotune
        continue-on-error: true
        run: |
          mkdir -p results
          bin/bobctl autotune \
            --profile "${{ steps.profile.outputs.name }}" \
            --manifest example/webapp-manifest.yaml \
            -n webapp \
            --ks-namespace honey \
            --functional-tests example/webapp-functional-tests.yaml \
            --attack-suite example/webapp-attacks.yaml \
            --alertmanager-service alertmanager \
            --alertmanager-port 9093 \
            --max-iterations 3 \
            --learn-timeout 5m \
            --output-dir results \
            --debug \
            -v 2>&1 | tee /tmp/autotune-output.txt

      - name: Export tuned ApplicationProfile
        if: always()
        run: |
          mkdir -p results
          bin/bobctl get "${{ steps.profile.outputs.name }}" -n webapp -o yaml > results/tuned-profile.yaml || true
          echo "Exported tuned profile ($(wc -l < results/tuned-profile.yaml) lines)"
          echo "Iteration profiles saved by --output-dir:"
          ls -la results/*-iteration*.yaml 2>/dev/null || echo "  (none)"
          cat results/*-iteration*.yaml

      - name: Display computed CollapseConfig
        if: always()
        run: |
          echo "=== Computed CollapseConfig ==="
          if [ -f results/collapse-config.json ]; then
            cat results/collapse-config.json
            echo ""
            echo "--- Storage ConfigMap patch command ---"
            echo "To apply this config to the storage ConfigMap for hot-reload:"
            echo "  kubectl patch configmap storage -n honey --type merge -p"
            echo "    '{\"data\":{\"collapseConfig.json\": \"'\"'\$(cat results/collapse-config.json)'\"'\"}}'"
          else
            echo "  (no collapse-config.json found — autotune may not have reached Phase 1)"
          fi



      - name: Run explicit attacks
        if: always()
        run: |
          mkdir -p results
          bin/bobctl attack \
            --attack-suite example/webapp-attacks.yaml \
            -n webapp \
            --format markdown | tee results/attack-results.md

      - name: Generate detection report
        if: always()
        run: |
          sleep 15  # wait for alert propagation
          mkdir -p results
          bin/bobctl report \
            --alertmanager-service alertmanager \
            --alertmanager-port 9093 \
            --ks-namespace honey \
            -n webapp \
            --format markdown | tee results/detection-report.md

      - name: Collect diagnostics
        if: always()
        run: |
          echo "--- Node-agent logs ---"
          kubectl logs -n honey -l app=node-agent --tail=100 || true
          echo "--- Storage logs ---"
          kubectl logs -n honey -l app=storage --tail=50 || true
          echo "--- Alertmanager alerts ---"
          kubectl get --raw "/api/v1/namespaces/honey/services/alertmanager:9093/proxy/api/v2/alerts?active=true" 2>/dev/null | jq '.[].labels' || echo "No alerts or alertmanager unreachable"

      - name: Prepare result artifact
        if: always()
        run: |
          KERNEL_VERSION=$(uname -r)
          mkdir -p results

          # Extract metrics from autotune output
          IMAGE_TAG=$(grep 'tag:' kubescape/values.yaml | head -1 | sed 's/.*tag: "\(.*\)"/\1/')
          SCORE=$(grep -oP 'score[:\s]+\K[0-9.]+' /tmp/autotune-output.txt 2>/dev/null | tail -1 || echo "N/A")
          MISSED=$(grep -ciP 'missed|undetected' /tmp/autotune-output.txt 2>/dev/null || echo "0")
          FP=$(grep -ciP 'false.positive' /tmp/autotune-output.txt 2>/dev/null || echo "0")
          RESULT="${{ steps.autotune.outcome }}"

          jq -n \
            --arg os "${{ matrix.os }}" \
            --arg k8s_distribution "${{ matrix.k8s-distribution }}" \
            --arg kubernetes_version "${{ matrix.kubernetes-version }}" \
            --arg kernel_version "$KERNEL_VERSION" \
            --arg profile "${{ steps.profile.outputs.name }}" \
            --arg autotune_exit_code "$RESULT" \
            --arg image_tag "$IMAGE_TAG" \
            --arg score "$SCORE" \
            --arg missed "$MISSED" \
            --arg false_positives "$FP" \
            --arg result "$RESULT" \
            '{
              os: $os,
              k8s_distribution: $k8s_distribution,
              kubernetes_version: $kubernetes_version,
              kernel_version: $kernel_version,
              profile: $profile,
              autotune_exit_code: $autotune_exit_code,
              image_tag: $image_tag,
              score: $score,
              missed: $missed,
              false_positives: $false_positives,
              result: $result
            }' > results/summary.json
          cp /tmp/autotune-output.txt results/ 2>/dev/null || true

      - name: Upload result artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.os }}-${{ matrix.k8s-distribution }}-${{ matrix.kubernetes-version }}
          path: results/

  summarize:
    name: Summary
    runs-on: ubuntu-latest
    needs: autotune
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate summary table
        run: |
          echo '### bobctl autotune — Matrix Results' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '| OS | K8s Distro | K8s Version | Kernel | Image Tag | Profile | Score | Missed | FP | Result |' >> $GITHUB_STEP_SUMMARY
          echo '|----|------------|-------------|--------|-----------|---------|-------|--------|----|--------|' >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/result-*; do
            if [ -f "$dir/summary.json" ]; then
              OS=$(jq -r '.os' "$dir/summary.json")
              K8S_DISTRO=$(jq -r '.k8s_distribution' "$dir/summary.json")
              K8S_VERSION=$(jq -r '.kubernetes_version' "$dir/summary.json")
              KERNEL=$(jq -r '.kernel_version' "$dir/summary.json")
              PROFILE=$(jq -r '.profile' "$dir/summary.json")
              EXIT=$(jq -r '.autotune_exit_code' "$dir/summary.json")
              IMAGE_TAG=$(jq -r '.image_tag // "N/A"' "$dir/summary.json")
              SCORE=$(jq -r '.score // "N/A"' "$dir/summary.json")
              MISSED=$(jq -r '.missed // "0"' "$dir/summary.json")
              FP=$(jq -r '.false_positives // "0"' "$dir/summary.json")
              if [ "$EXIT" == "success" ]; then STATUS="Pass"; else STATUS="$EXIT"; fi
              echo "| $OS | $K8S_DISTRO | $K8S_VERSION | $KERNEL | \`$IMAGE_TAG\` | \`$PROFILE\` | $SCORE | $MISSED | $FP | $STATUS |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Append per-variant detection details
          echo '' >> $GITHUB_STEP_SUMMARY
          for dir in artifacts/result-*; do
            VARIANT=$(basename "$dir" | sed 's/^result-//')
            if [ -f "$dir/detection-report.md" ] || [ -f "$dir/attack-results.md" ]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary><b>$VARIANT</b> — Detection Details</summary>" >> $GITHUB_STEP_SUMMARY
              echo '' >> $GITHUB_STEP_SUMMARY
              if [ -f "$dir/attack-results.md" ]; then
                echo '#### Attack Results' >> $GITHUB_STEP_SUMMARY
                cat "$dir/attack-results.md" >> $GITHUB_STEP_SUMMARY
                echo '' >> $GITHUB_STEP_SUMMARY
              fi
              if [ -f "$dir/detection-report.md" ]; then
                echo '#### Detection Matrix' >> $GITHUB_STEP_SUMMARY
                cat "$dir/detection-report.md" >> $GITHUB_STEP_SUMMARY
                echo '' >> $GITHUB_STEP_SUMMARY
              fi
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo '' >> $GITHUB_STEP_SUMMARY
            fi
          done
